---
title: Elasticsearch基本概念
date: 2021-02-14 23:10:57
categories: ELK
tags:
    - ELK
    - Search
keywords:
  - Elasticsearch
  - Kibana
---

![Search](https://gitee.com/michael_xiang/images/raw/master/uPic/pexels-andrea-piacquadio-3769697.jpg)

## 文档 Document

ES 是面向文档的，文档是所有课搜索数据的最小单位。例如：
- 日志文件中的日志项
- 一本电影的具体信息

文档会被序列化为 JSON 格式，保存在 ES 中
- JSON 对象由字段组成
- 每个字段都有对应的字段类型

每个文档都有一个 Unique ID
- 可以自定义 ID
- 或者 ES 自动生成

### 文档的元数据

元数据，用于标准文档的相关信息
- `_id`：一篇文档的唯一 ID
- `_index`：文档所属的索引名
- `_source`：文档的原始 JSON 数据
- `_version`：文档版本信息
- `_score`：相关性打分
- `_all`：整合所有字段内容到该字段，已被废除

## 索引

Index 索引是文档的容器，是一类「文档」的集合
- Index：体现了逻辑空间的概念：每个索引都有自己的 Mapping 定义，用于定义包含的文档的字段名和字段类型
- Shard：体现了物理空间的概念：索引中的数据分散在 Shard 上

索引的 Mapping 与 Settings：
- Mapping 定义文档字段的类型
- Setting 定义不同的数据分布

### 索引的不同语义

索引这个词在不同的上下文中是有不同的含义的。

> 索引（动词）文档到 ES 的索引（名词）中。

- 名词：ES 集群中可以创建很多个不同的索引
- 动词：保存文档到 ES 的过程也叫索引（indexing），ES 中创建一个倒排索引的过程

## Type

- 在 ES7 之前，一个 Index 可以设置成多个 Types
- 在 ES7 开始，一个 Index 仅可以创建一个 Type `_doc`

## 关系型数据库与 ES 的比较

类比：

| RDMS   | ES       |
| ------ | -------- |
| Table  | Index    |
| Row    | Document |
| Column | Field    |
| Schema | Mapping  |
| SQL    | DSL      |

传统关系型数据库与 ES 的区别：
- ES：相关性/高性能全文检索
- RDMS：事务性/Join

## 分片（Primary Shard & Replica Shard）

- 主分片，用以解决数据水平扩展的问题。通过主分片，可以将数据分不到集群内的所有节点之上
  - 一个分片就是一个运行的 Lucene 的实例
  - 主分片数在索引创建时指定，**后续不允许修改**，除非 Reindex
- 副本，用以解决数据高可用的问题。副本分片是主分片的拷贝。当主分片丢失，集群会选择对应的副本分片称为主分片
  - 副本分片数是可以动态调整的
  - 增加副本数，还可以在一定程度上提高服务的可用性（读取的吞吐 ）。
  
增删改属于写操作，增加副本只可能降低写入速度，但是会提高数据安全性。从写的角度看，会把请求分发到不同的副本，只要这些副本在不同的机器，机器资源又足够，那就实现了水平的扩展，提高了读取的并发性。

补充：
- 一个 ES node 对应一个 ES 实例
- 一个 ES node 可以有多个 index
- 一个 index 可以有多个 shard
- 一个 shard 是一个 Lucene index（这里的 index 是 Lucene 自己概念，和 ES 中的 index 不是一个概念）

### 分片的设定

- 对于生产环境中分片的设定，需要提前做好容量规划
  - 分片数设置过小
    - 导致后续无法实现增加节点实现水平扩展
    - 单个分片的数据量太大，导致数据重新分配耗时
  - 分片数设置过大，7.0 开始，默认主分片数设置成1，解决了 over-sharding 的问题
    - 影响搜索结果的相关性打分，影响统计结果的准确性（因为 idf 是基于分片上的数据进行计算的，并不是基于所有分片计算，所以数据量少，容易出现不准的情况）
    - 单个节点上过多的分片，会导致资源浪费，同时也会影响性能

从数据量、写入速度、是写为主还是查询为主等等，考虑分片的设置：
- 磁盘推荐 SSD
- JVM 最大 Xmx 不要超过 30G
- 副本分片至少设置为 1
- 主分片单个存储不要超过 30GB，按照这个推算出分片数


查看集群的健康状况：`GET _cluster/health`
- Green：主分片与副本都正常分配
- Yellow：主分片全部正常分配，有副本分片未能正常分配
- Red：有主分片未能分配
  - 例如，当服务器磁盘容量超过 85%时，去创建了一个新的索引

## 参考
- [极客时间-](https://time.geekbang.org/course/detail/100030501-102667)